<?php

namespace App\Entities;

use App\Contracts\GeneratesUniqueHash;
use App\Contracts\HasIdColumn;
use App\Contracts\RelatesToFiles;
use App\Entities\Base\AbstractEntity;
use Doctrine\Common\Collections\ArrayCollection;
use Doctrine\ORM\Mapping as ORM;
use Illuminate\Support\Collection;

/**
 * App\Entities\Vulnerability
 *
 * @ORM\Entity(repositoryClass="App\Repositories\VulnerabilityRepository")
 * @ORM\HasLifecycleCallbacks
 */
class Vulnerability extends Base\Vulnerability implements HasIdColumn, RelatesToFiles, GeneratesUniqueHash
{
    const FILES    = 'files';
    const ASSETS   = 'assets';
    const EXPLOITS = 'exploits';

    const SEVERITY_INFORMATION = 'Information';
    const SEVERITY_LOW         = 'Low';
    const SEVERITY_MEDIUM      = 'Medium';
    const SEVERITY_HIGH        = 'High';
    const SEVERITY_CRITICAL    = 'Critical';

    const SEVERITY_INFORMATION_DEFAULT_SCORE = 0;
    const SEVERITY_LOW_DEFAULT_SCORE         = 3.9;
    const SEVERITY_MEDIUM_DEFAULT_SCORE      = 6.9;
    const SEVERITY_HIGH_DEFAULT_SCORE        = 9.9;
    const SEVERITY_CRITICAL_DEFAULT_SCORE    = 10;

    /**
     * @ORM\ManyToMany(targetEntity="File", mappedBy="vulnerabilities", indexBy="id")
     */
    protected $files;

    /**
     * @ORM\ManyToMany(targetEntity="Asset", mappedBy="vulnerabilities")
     */
    protected $assets;

    /**
     * @ORM\ManyToMany(targetEntity="Exploit", inversedBy="vulnerabilities", indexBy="title", cascade={"persist"})
     * @ORM\JoinTable(name="vulnerabilities_exploits")
     */
    protected $exploits;

    /**
     * Vulnerability constructor.
     */
    public function __construct()
    {
        parent::__construct();
        $this->files    = new ArrayCollection();
        $this->assets   = new ArrayCollection();
        $this->exploits = new ArrayCollection();
    }

    /**
     * Check that that we received a valid severity
     *
     * @param float $severity
     * @return Base\Vulnerability
     */
    public function setSeverity($severity)
    {
        if (is_numeric($severity)) {
            return parent::setSeverity($severity);
        }

        // Check is the score is in the map
        $score = $this->getSeverityTextToScoreMap()->get($severity);
        if (!isset($score)) {
            return $this;
        }

        return parent::setSeverity($score);
    }

    /**
     * Override the parent method to set the $malwareAvailable property at the same time
     *
     * @param string $malware_description
     * @return Base\Vulnerability
     */
    public function setMalwareDescription($malware_description)
    {
        $this->setMalwareAvailable(!empty($malware_description));
        return parent::setMalwareDescription($malware_description);
    }

    /**
     * Override parent method to format the date when an invalid date format is encountered
     *
     * @param \DateTime $published_date_from_scanner
     * @return Base\Vulnerability
     */
    public function setPublishedDateFromScanner($published_date_from_scanner)
    {
        if (empty($this->sanitiseDate($published_date_from_scanner))) {
            return $this;
        }

        return parent::setPublishedDateFromScanner(
            $this->sanitiseDate($published_date_from_scanner)
        );
    }

    /**
     * Override parent method to format the date when an invalid date format is encountered
     *
     * @param \DateTime $modified_date_from_scanner
     * @return Base\Vulnerability
     */
    public function setModifiedDateFromScanner($modified_date_from_scanner)
    {
        if (empty($this->sanitiseDate($modified_date_from_scanner))) {
            return $this;
        }

        return parent::setModifiedDateFromScanner(
            $this->sanitiseDate($modified_date_from_scanner)
        );
    }

    /**
     * Override the parent method to set the inverse relation on the VulnerabilityReferenceCode
     *
     * @param Base\VulnerabilityReferenceCode $vulnerabilityReferenceCode
     * @return Base\Vulnerability
     */
    public function addVulnerabilityReferenceCode(Base\VulnerabilityReferenceCode $vulnerabilityReferenceCode)
    {
        if ($this->getVulnerabilityReferenceCodes()->contains($vulnerabilityReferenceCode)) {
            return $this;
        }

        $vulnerabilityReferenceCode->setVulnerability($this);
        return parent::addVulnerabilityReferenceCode($vulnerabilityReferenceCode);
    }

    /**
     * @param Exploit $exploit
     * @return $this
     */
    public function addExploit(Exploit $exploit)
    {
        if ($this->getExploits()->contains($exploit)) {
            return $this;
        }

        $relationKey = $exploit->getId() ?? $exploit->getHash();
        $this->exploits[$relationKey] = $exploit;

        return $this;
    }

    /**
     * Get a related exploit by it's hash
     *
     * @param string $hash
     * @return Exploit|null
     */
    public function getExploit(string $hash)
    {
        if (!isset($this->exploits[$hash])) {
            return null;
        }

        return $this->exploits[$hash];
    }

    /**
     * @param Exploit $exploit
     * @return $this
     */
    public function removeExploit(Exploit $exploit)
    {
        $this->exploits->removeElement($exploit);

        return $this;
    }

    /**
     * @return ArrayCollection
     */
    public function getExploits()
    {
        return $this->exploits;
    }

    /**
     * Get a hash value of all the property values whose combination creates a unique key
     *
     * @return string
     */
    public function getHash(): string
    {
        return AbstractEntity::generateUniqueHash($this->getUniqueKeyColumns());
    }

    /**
     * @return Collection
     */
    public function getUniqueKeyColumns(): Collection
    {
        return new Collection([
            parent::ID_FROM_SCANNER => $this->id_from_scanner,
            parent::NAME            => $this->name,
        ]);
    }

    /**
     * Map of Information, Low, Medium, High and Critical severities to the relevant score
     *
     * @return Collection
     */
    public function getSeverityTextToScoreMap(): Collection
    {
        return collect([
            self::SEVERITY_INFORMATION => self::SEVERITY_INFORMATION_DEFAULT_SCORE,
            self::SEVERITY_LOW         => self::SEVERITY_LOW_DEFAULT_SCORE,
            self::SEVERITY_MEDIUM      => self::SEVERITY_MEDIUM_DEFAULT_SCORE,
            self::SEVERITY_HIGH        => self::SEVERITY_HIGH_DEFAULT_SCORE,
            self::SEVERITY_CRITICAL    => self::SEVERITY_CRITICAL_DEFAULT_SCORE,
        ]);
    }

    /**
     * @param File $file
     * @return $this
     */
    public function addFile(File $file)
    {
        $this->files[$file->getId()] = $file;

        return $this;
    }

    /**
     * @param File $file
     * @return $this
     */
    public function removeFile(File $file)
    {
        $this->files->removeElement($file);

        return $this;
    }

    /**
     * @param Asset $asset
     * @return $this
     */
    public function addAsset(Asset $asset)
    {
        $this->assets[$asset->getId()] = $asset;

        return $this;
    }

    /**
     * @param Asset $asset
     * @return $this
     */
    public function removeAsset(Asset $asset)
    {
        $this->assets->removeElement($asset);

        return $this;
    }
}