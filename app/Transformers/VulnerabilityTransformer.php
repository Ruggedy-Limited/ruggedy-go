<?php

namespace App\Transformers;

use App\Entities\Vulnerability;
use League\Fractal\TransformerAbstract;

class VulnerabilityTransformer extends TransformerAbstract
{
    /**
     * List of resources possible to include
     *
     * @var array
     */
    protected $availableIncludes = [
        'exploits',
        'referenceCodes',
    ];

    /**
     * Transform a Vulnerability entity for the API
     *
     * @param Vulnerability $vulnerability
     * @return array
     */
    public function transform(Vulnerability $vulnerability)
    {
        return [
            'id'                 => $vulnerability->getId(),
            'sourceId'           => $vulnerability->getIdFromScanner(),
            'name'               => $vulnerability->getName(),
            'description'        => $vulnerability->getDescription(),
            'severity'           => $vulnerability->getSeverity(),
            'pciSeverity'        => $vulnerability->getPciSeverity(),
            'isMalwareAvailable' => $vulnerability->getMalwareAvailable(),
            'malwareDescription' => $vulnerability->getMalwareDescription(),
            'impact'             => $vulnerability->getImpact(),
            'cvssScore'          => $vulnerability->getCvssScore(),
            'resolution'         => $vulnerability->getSolution(),
            'genericOutput'      => $vulnerability->getGenericOutput(),
            'attackType'         => $vulnerability->getAttackType(),
            'createdDate'        => $vulnerability->getCreatedAt()->format(env('APP_DATE_FORMAT')),
            'modifiedDate'       => $vulnerability->getUpdatedAt()->format(env('APP_DATE_FORMAT')),
        ];
    }

    /**
     * Optional include for Exploits
     *
     * @param Vulnerability $vulnerability
     * @return \League\Fractal\Resource\Collection
     */
    public function includeExploits(Vulnerability $vulnerability)
    {
        return $this->collection($vulnerability->getExploits(), new ExploitTransformer());
    }

    /**
     * Optional include for Vulnerability Reference Codes
     *
     * @param Vulnerability $vulnerability
     * @return \League\Fractal\Resource\Collection
     */
    public function includeReferenceCodes(Vulnerability $vulnerability)
    {
        return $this->collection(
            $vulnerability->getVulnerabilityReferenceCodes(), new VulnerabilityReferenceCodeTransformers()
        );
    }
}